<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Auto Crop Resistor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#0f172a;
  color:white;
  font-family:system-ui;
  text-align:center;
}

h2{ margin:10px }

video, canvas{
  width:95%;
  max-width:420px;
  border-radius:16px;
  margin-top:10px;
}

button{
  margin:15px;
  padding:14px 30px;
  font-size:18px;
  border:none;
  border-radius:50px;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;
  cursor:pointer;
}

#result{
  margin-top:10px;
  font-size:18px;
}
</style>
</head>

<body>
<h2>üì∑ Auto Crop Resistor</h2>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" hidden></canvas>
<canvas id="crop"></canvas>

<button id="scanBtn" disabled>‚è≥ Loading OpenCV...</button>
<div id="result"></div>

<script src="https://docs.opencv.org/4.x/opencv.js"></script>
  
  <script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let cropCanvas = document.getElementById("crop");
let scanBtn = document.getElementById("scanBtn");
let result = document.getElementById("result");

let cvReady = false;

/* Kamera */
async function initCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:{ ideal:"environment" } }
  });
  video.srcObject = stream;
}

/* OpenCV siap */
window.Module = {
  onRuntimeInitialized(){
    cvReady = true;
    scanBtn.disabled = false;
    scanBtn.innerText = "SCAN & AUTO CROP";
  }
};

scanBtn.onclick = autoCropResistor;

function autoCropResistor(){
  if(!cvReady) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  cropCanvas.width = canvas.width;
  cropCanvas.height = canvas.height;

  let ctx = canvas.getContext("2d");
  ctx.drawImage(video,0,0);

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  let blur = new cv.Mat();
  let edges = new cv.Mat();

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, blur, new cv.Size(5,5),0);
  cv.Canny(blur, edges, 80, 150);

  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let bestRect = null;
  let maxArea = 0;

  for(let i=0;i<contours.size();i++){
    let cnt = contours.get(i);
    let rect = cv.boundingRect(cnt);

    let ratio = rect.width / rect.height;
    let area = rect.width * rect.height;

    /* Filter khas resistor */
    if(ratio > 2.5 && ratio < 8 && area > 5000){
      if(area > maxArea){
        maxArea = area;
        bestRect = rect;
      }
    }
  }

  if(bestRect){
    let roi = src.roi(bestRect);
    cv.imshow("crop", roi);
    result.innerHTML = "‚úÖ Resistor terdeteksi & dicrop";
    roi.delete();
  }else{
    result.innerHTML = "‚ùå Resistor tidak terdeteksi";
  }

  src.delete(); gray.delete(); blur.delete();
  edges.delete(); contours.delete(); hierarchy.delete();
}
</script>
</body>
</html>
