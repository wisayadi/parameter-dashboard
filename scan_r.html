<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resistor Color Band Scanner PRO</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:#020617;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.app{
  width:94%;
  max-width:420px;
  background:#0f172a;
  border-radius:18px;
  padding:12px;
}
h1{
  font-size:15px;
  text-align:center;
  color:#38bdf8;
}
video{
  width:100%;
  border-radius:14px;
  border:2px solid #00ffcc;
}
.result{
  margin-top:10px;
  padding:10px;
  background:#020617;
  border-radius:14px;
  text-align:center;
}
.value{
  font-size:26px;
  color:#9aff00;
  font-weight:bold;
}
button{
  width:100%;
  margin-top:10px;
  padding:12px;
  border:none;
  border-radius:12px;
  background:linear-gradient(90deg,#00ffcc,#00bfa5);
  font-weight:bold;
}
</style>

<script>
let cvReady=false;
var Module={
  onRuntimeInitialized(){
    cvReady=true;
    scanBtn.disabled=false;
    scanBtn.innerText="SCAN RESISTOR";
  }
}
</script>
<script src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>

<body>
<div class="app">
<h1>üì∑ Resistor Color Band Scanner</h1>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas" hidden></canvas>

<div class="result">
  <div>Detected Value</div>
  <div class="value" id="value">‚Äî</div>
</div>

<button id="scanBtn" disabled>‚è≥ Loading OpenCV...</button>
</div>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const valueEl=document.getElementById("value");
const scanBtn=document.getElementById("scanBtn");

navigator.mediaDevices.getUserMedia({
  video:{facingMode:"environment"}
}).then(s=>video.srcObject=s);

/* ===============================
   SCAN RESISTOR
================================ */
function scan(){
  if(!cvReady) return;

  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);

  let src=cv.imread(canvas);
  let hsv=new cv.Mat();
  cv.cvtColor(src,hsv,cv.COLOR_RGBA2HSV);

  /* üî• AUTO-CROP AREA TENGAH */
  let cx=src.cols*0.15;
  let cy=src.rows*0.4;
  let cw=src.cols*0.7;
  let ch=src.rows*0.25;
  let roi=hsv.roi(new cv.Rect(cx,cy,cw,ch));

  let bands=[];

  const colors=[
    {d:0, low:[0,0,0], high:[180,255,50]},      // hitam
    {d:1, low:[5,80,40], high:[20,255,200]},    // coklat
    {d:2, low:[0,120,120], high:[10,255,255]},  // merah
    {d:3, low:[11,120,120], high:[25,255,255]}, // oranye
    {d:4, low:[26,100,100], high:[35,255,255]}, // kuning
    {d:5, low:[36,60,60], high:[85,255,255]},   // hijau
    {d:6, low:[86,60,60], high:[125,255,255]},  // biru
    {d:7, low:[126,50,50], high:[160,255,255]}  // ungu
  ];

  colors.forEach(c=>{
    let mask=new cv.Mat();
    cv.inRange(
      roi,
      new cv.Scalar(...c.low,0),
      new cv.Scalar(...c.high,255),
      mask
    );

    let cnts=new cv.MatVector();
    let hier=new cv.Mat();
    cv.findContours(mask,cnts,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

    for(let i=0;i<cnts.size();i++){
      let r=cv.boundingRect(cnts.get(i));
      let area=r.width*r.height;
      let ratio=r.height/r.width;

      if(area>300 && ratio>1.5 && ratio<6){
        bands.push({x:r.x, digit:c.d});
      }
    }
    mask.delete(); cnts.delete(); hier.delete();
  });

  src.delete(); hsv.delete(); roi.delete();

  if(bands.length<3){
    valueEl.innerText="‚ùå Band tidak terbaca";
    return;
  }

  bands.sort((a,b)=>a.x-b.x);

  let value=(bands[0].digit*10+bands[1].digit)
            *Math.pow(10,bands[2].digit);

  valueEl.innerText =
    value>=1e6 ? (value/1e6)+" MŒ©" :
    value>=1e3 ? (value/1e3)+" kŒ©" :
    value+" Œ©";
}

scanBtn.onclick=scan;
</script>
</body>
</html>
