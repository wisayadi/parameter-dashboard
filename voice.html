<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gempa + TTS (Play / Stop)</title>
<style>
  :root { --blue1: #4facfe; --blue2:#00f2fe; --red1:#ff5858; --red2:#ff2e63; }

  body { font-family: Arial, Helvetica, sans-serif; margin:18px; background: linear-gradient(#f7fbff,#fff); }

  /* running text */
  .info-gempa {
    width:100%;
    overflow:hidden;
    white-space:nowrap;
    background:#0a0a0a;
    padding:10px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    margin-bottom:18px;
  }
  .scrolling-text {
    display:inline-block;
    padding-left:100%;
    animation:scroll-left 35s linear infinite;
    color:#ffd54f;
    font-weight:700;
    font-size:14px;
  }
  @keyframes scroll-left {
    0%{transform:translateX(0%);}
    100%{transform:translateX(-100%);}
  }

  /* single play/stop button â€” use inline styles from JS to force color */
  #ttsButton {
    width: 90%;
    max-width:420px;
    display:block;
    margin: 10px auto;
    padding: 14px 18px;
    font-size:18px;
    font-weight:700;
    color:#fff !important;
    border:none;
    border-radius:14px;
    cursor:pointer;
    box-shadow: 0 8px 26px rgba(0,0,0,0.12);
    transition: transform .15s ease, box-shadow .15s ease;
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    outline: none;
  }
  #ttsButton:active { transform: translateY(2px); }

  /* small helper */
  .muted { text-align:center; font-size:12px; color:#666; margin-top:8px; }
  .tiny { font-size:12px; color:#333; margin-top:6px; text-align:center; }
</style>
</head>
<body>

<h3 style="text-align:center;margin:6px 0 14px 0;">Info Gempa BMKG â€” TTS Play / Stop</h3>

<div class="info-gempa" id="infoBox">
  <span id="scrollGempa" class="scrolling-text">Memuat data gempa terkini dari BMKG...</span>
</div>

<!-- tombol tunggal play / stop -->
<button id="ttsButton" aria-pressed="false">ðŸ”Š Baca Info Gempa</button>

<div style="text-align:center;margin-top:6px;">
  <button id="testVoice" style="padding:8px 12px;border-radius:10px;border:none;cursor:pointer">ðŸ§ª Test Voice (browser)</button>
</div>
<div class="muted">Jika tombol tetap tidak berubah: coba buka halaman ini di Chrome Android dulu.</div>

<script>
/* ---------------------------
   Utility & state
   --------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const ttsButton = document.getElementById('ttsButton');
  const scrollEl = document.getElementById('scrollGempa');
  const testBtn = document.getElementById('testVoice');

  // state
  let speaking = false;
  let utterance = null;

  // set initial style (force inline)
  ttsButton.style.background = "linear-gradient(90deg, var(--blue1), var(--blue2))";
  ttsButton.textContent = "ðŸ”Š Baca Info Gempa";

  /* ============================
     Fetch BMKG running text once & every 5 min
     ============================ */
  async function fetchGempa() {
    try {
      const res = await fetch('https://data.bmkg.go.id/DataMKG/TEWS/autogempa.json');
      const data = await res.json();
      const g = data.Infogempa.gempa; // object
      // Build readable text
      const teks = `Gempa tanggal ${g.Tanggal} pukul ${g.Jam} WIB. Magnitudo ${g.Magnitude} SR. Kedalaman ${g.Kedalaman}. Lokasi: ${g.Wilayah}. ${g.Potensi || ''}`;
      scrollEl.textContent = teks;
      // restart animation (ensure it restarts)
      scrollEl.style.animation = 'none';
      void scrollEl.offsetWidth;
      scrollEl.style.animation = '';
      scrollEl.style.animation = 'scroll-left 35s linear infinite';
    } catch (err) {
      console.error('fetchGempa error', err);
      scrollEl.textContent = 'âš ï¸ Gagal memuat data gempa dari BMKG.';
    }
  }
  fetchGempa();
  setInterval(fetchGempa, 5 * 60 * 1000);

  /* ============================
     Feature detection: browser TTS available?
     ============================ */
  function supportsWebSpeech() {
    return 'speechSynthesis' in window && typeof SpeechSynthesisUtterance !== 'undefined';
  }

  /* Check in-app WebView bridge (AppsGeyser etc). We'll fallback to send string if present */
  function sendToHostTTS(text) {
    try {
      // AppInventor style
      if (window.AppInventor && typeof window.AppInventor.setWebViewString === 'function') {
        window.AppInventor.setWebViewString("TTS:" + text);
        return true;
      }
      // generic bridge name used before
      if (typeof window.setWebViewString === 'function') {
        window.setWebViewString("TTS:" + text);
        return true;
      }
      // Cordova/Android WebView can implement a global object, e.g. Android
      if (window.Android && typeof window.Android.speak === 'function') {
        window.Android.speak(text);
        return true;
      }
    } catch(e) {
      console.warn('sendToHostTTS failed', e);
    }
    return false;
  }

  /* ============================
     Speak (browser) and control button visuals (inline style)
     ============================ */
  function startSpeak(text) {
    if (!supportsWebSpeech()) {
      // fallback: attempt host native TTS
      const sent = sendToHostTTS(text);
      if (sent) {
        speaking = true;
        updateBtnVisual();
      } else {
        alert('TTS tidak tersedia di WebView ini. Coba buka di Chrome atau gunakan native bridge.');
      }
      return;
    }

    // Cancel any existing
    window.speechSynthesis.cancel();

    utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'id-ID';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;

    // events
    utterance.onend = () => {
      speaking = false;
      updateBtnVisual();
    };
    utterance.onerror = (e) => {
      console.error('TTS error', e);
      speaking = false;
      updateBtnVisual();
    };

    speaking = true;
    updateBtnVisual();
    window.speechSynthesis.speak(utterance);
  }

  function stopSpeak() {
    // stop browser
    if (supportsWebSpeech()) {
      window.speechSynthesis.cancel();
    }
    // also notify host native to stop (if exists)
    try {
      if (window.AppInventor && typeof window.AppInventor.setWebViewString === 'function') {
        window.AppInventor.setWebViewString("TTS:STOP");
      } else if (typeof window.setWebViewString === 'function') {
        window.setWebViewString("TTS:STOP");
      } else if (window.Android && typeof window.Android.stopSpeak === 'function') {
        window.Android.stopSpeak();
      }
    } catch(e) { /* ignore */ }

    speaking = false;
    updateBtnVisual();
  }

  function updateBtnVisual() {
    // Use inline style so WebView's default won't override
    if (speaking) {
      ttsButton.textContent = "â¹ Stop Membaca";
      ttsButton.style.background = "linear-gradient(90deg, var(--red1), var(--red2))";
      ttsButton.setAttribute('aria-pressed','true');
    } else {
      ttsButton.textContent = "ðŸ”Š Baca Info Gempa";
      ttsButton.style.background = "linear-gradient(90deg, var(--blue1), var(--blue2))";
      ttsButton.setAttribute('aria-pressed','false');
    }
  }

  /* ============================
     toggle handler bound to button
     ============================ */
  ttsButton.addEventListener('click', () => {
    // If currently not speaking, we MUST treat this as an explicit user gesture to unlock TTS
    if (!speaking) {
      // prefer running text content
      const text = (document.getElementById('scrollGempa')?.innerText || '').trim();
      if (!text) {
        alert('Belum ada teks gempa untuk dibacakan.');
        return;
      }

      // unlock issue on Chrome Android: sometimes need a short dummy utterance or resume
      if (supportsWebSpeech()) {
        try {
          // Ensures engine ready
          window.speechSynthesis.cancel();
        } catch(e){}
      }
      startSpeak(text);
      return;
    }
    // else stop
    stopSpeak();
  });

  /* Test voice button for debugging in browser */
  testBtn.addEventListener('click', () => {
    if (!supportsWebSpeech()) {
      alert('SpeechSynthesis tidak tersedia pada WebView ini.');
      return;
    }
    // Show voices in console
    const voices = window.speechSynthesis.getVoices();
    console.log('voices', voices);
    alert('Voices: ' + (voices.length ? voices.map(v=>v.name+'('+v.lang+')').join(', ') : 'Tidak tersedia (akan muncul setelah onvoiceschanged).'));
    const t = new SpeechSynthesisUtterance('Tes text to speech. Jika tidak terdengar, coba buka di Chrome.');
    t.lang = 'id-ID';
    window.speechSynthesis.speak(t);
  });

  /* if voices load later */
  if (supportsWebSpeech()) {
    window.speechSynthesis.onvoiceschanged = function() {
      console.log('voiceschanged', window.speechSynthesis.getVoices());
    };
  }

});
</script>
</body>
</html>
