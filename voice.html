<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
<title>Info Gempa â€” PWA Fullscreen</title>
<style>
  :root{ --blue1:#4facfe; --blue2:#00f2fe; --red1:#ff5858; --red2:#ff2e63; }
  html,body{height:100%;margin:0}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(#f7fbff,#fff);padding:18px;box-sizing:border-box;}
  h3{text-align:center;color:#6b3b2b;margin:6px 0 14px 0;font-size:14px;margin-top:54px;margin-bottom:4px}
  .info-gempa{background:grey;background-size:400% 400%;padding:8px 0;margin-top:12px;margin-bottom:10px;width:100%;overflow:hidden;white-space:nowrap;text-align:center;border-radius:8px;border:1px solid brown;animation:gradientFlow 6s ease infinite}
  .scrolling-text{display:inline-block;padding-left:100%;animation:scroll-left 45s linear infinite;transition:opacity 1s;font-weight:600;font-size:12px;color:#fff;text-shadow:0 0 6px rgba(0,0,0,.3)}
  @keyframes scroll-left{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  @keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  /* play/stop button */
  #ttsToggle{width:64%;max-width:420px;display:block;margin:18px auto;padding:14px 18px;font-size:16px;font-weight:700;color:#fff;border:none;border-radius:16px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.18);transition:transform .15s, box-shadow .15s}
  #ttsToggle:active{transform:scale(.98)}
  .btn-play{background:linear-gradient(90deg,var(--blue1),var(--blue2));}
  .btn-stop{background:linear-gradient(90deg,var(--red1),var(--red2));}

  /* ripple */
  #ttsToggle{position:relative;overflow:hidden}
  #ttsToggle::after{content:"";position:absolute;width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,.4);transform:scale(0);opacity:0;transition:transform .5s,opacity .5s;pointer-events:none}
  #ttsToggle.ripple::after{transform:scale(30);opacity:0}

  /* equalizer RGB */
  .equalizer{display:flex;justify-content:center;align-items:flex-end;gap:6px;height:70px;margin-top:12px}
  .equalizer span{width:6px;border-radius:6px;transform-origin:bottom;box-shadow:0 0 12px rgba(255,255,255,.4);animation:bar 0.9s ease-in-out infinite, hue 3s linear infinite}
  .equalizer span:nth-child(1){animation-delay:0ms}
  .equalizer span:nth-child(2){animation-delay:120ms}
  .equalizer span:nth-child(3){animation-delay:240ms}
  .equalizer span:nth-child(4){animation-delay:360ms}
  .equalizer span:nth-child(5){animation-delay:480ms}
  .equalizer span:nth-child(6){animation-delay:600ms}
  .equalizer span:nth-child(7){animation-delay:720ms}
  .equalizer span:nth-child(8){animation-delay:840ms}
  .equalizer span:nth-child(9){animation-delay:960ms}
  .equalizer span:nth-child(10){animation-delay:1080ms}
  @keyframes bar{0%{transform:scaleY(.2)}50%{transform:scaleY(1)}100%{transform:scaleY(.2)}}
  @keyframes hue{0%{background:rgb(255,0,0)}16%{background:rgb(255,127,0)}33%{background:rgb(255,255,0)}50%{background:rgb(0,255,0)}66%{background:rgb(0,0,255)}83%{background:rgb(139,0,255)}100%{background:rgb(255,0,0)}}
  .hidden{display:none}

  /* small helpers */
  .muted{text-align:center;font-size:12px;color:#666;margin-top:8px}
  .ping-indicator{position:fixed;top:10px;right:10px;padding:6px 10px;font-size:12px;font-weight:600;color:#fff;border-radius:14px;background:rgba(0,0,0,.4);backdrop-filter:blur(8px);z-index:999}
  .net-popup-ios{position:fixed;top:-120px;left:50%;transform:translateX(-50%) scale(.95);padding:14px 26px;font-size:15px;font-weight:600;border-radius:22px;backdrop-filter:blur(12px);background:rgba(255,255,255,.18);color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.25);z-index:9999;display:none;text-align:center}
  .net-popup-ios.show{top:20px;transform:translateX(-50%) scale(1)}
  .net-popup-ios.success {
  background: rgba(26, 188, 156, 0.55);
}
  .net-popup-ios.error {
  background: rgba(231, 76, 60, 0.55);
}

  /* make app area safe for notch */
  main{padding:12px}
</style>
</head>
<body>
<h3>Info Gempa BMKG â€” TTS Play / Stop</h3>
<main>
  <div class="info-gempa" id="infoBox"><span id="scrollGempa" class="scrolling-text">Memuat data gempa terkini dari BMKG...</span></div>

  <button id="ttsToggle" class="btn-play" aria-pressed="false">ðŸ”Š Baca Info Gempa</button>

  <!-- beep sound (remote) -->
  <audio id="beepClick" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/mpeg">
  </audio>

  <div id="equalizer" class="equalizer hidden">
    <span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span>
  </div>

  <div id="pingBox" class="ping-indicator">ðŸ”„ Ping...</div>
  <div id="netPopup" class="net-popup-ios"></div>
  <div class="muted">Sumber data: BMKG Nasional</div>
</main>

<script>
// --- PWA assets generated as blobs so this single file is portable ---
(function(){
  // create manifest blob and link
  const manifest = {
    name: "Info Gempa - TTS",
    short_name: "GempaTTS",
    start_url: ".",
    scope: ".",
    display: "standalone",
    orientation: "portrait-primary",
    background_color: "#000000",
    theme_color: "#000000",
    icons: [
      {src: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192"><rect width="100%" height="100%" fill="#1e3a8a"/><text x="50%" y="55%" font-size="72" fill="#fff" text-anchor="middle" font-family="Arial">G</text></svg>'), sizes: '192x192', type: 'image/svg+xml'},
      {src: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="#1e3a8a"/><text x="50%" y="55%" font-size="220" fill="#fff" text-anchor="middle" font-family="Arial">G</text></svg>'), sizes: '512x512', type: 'image/svg+xml'}
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const manifestURL = URL.createObjectURL(manifestBlob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestURL;
  document.head.appendChild(link);

  // Service worker code as blob (simple cache-first)
  const swCode = `self.addEventListener('install', e=>{self.skipWaiting();e.waitUntil(caches.open('gempa-cache-v1').then(c=>c.addAll(['.','/'])))});
self.addEventListener('activate', e=>{e.waitUntil(clients.claim())});
self.addEventListener('fetch', e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match('/'))))});`;
  const swBlob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register(swUrl).then(()=>console.log('SW registered (blob)')).catch(e=>console.warn('SW failed',e));
  }
})();

// --- App logic: fetch BMKG, TTS, beep, equalizer, fullscreen on add to home screen ---
document.addEventListener('DOMContentLoaded', ()=>{
  const ttsBtn = document.getElementById('ttsToggle');
  const beep = document.getElementById('beepClick');
  const equalizer = document.getElementById('equalizer');
  const bars = equalizer.querySelectorAll('span');
  const scrollEl = document.getElementById('scrollGempa');
  
  window.addEventListener("load", () => {
  const popup = document.getElementById("netPopup");

  function showPopup(msg, style) {
    popup.innerHTML = msg;
    popup.className = `net-popup-ios ${style}`;
    popup.style.display = "block";

    setTimeout(() => popup.classList.add("show"), 20);

    setTimeout(() => {
      popup.classList.remove("show");
      setTimeout(() => popup.style.display = "none", 600);
    }, 8000);
  }

  window.addEventListener("offline", () => {
    showPopup("ðŸ”Œ Jaringan Terputus", "error");
    if (navigator.vibrate) navigator.vibrate([160,80,160]);
  });

  window.addEventListener("online", () => {
    showPopup("ðŸ“¶ Internet Tersambung", "success");
    if (navigator.vibrate) navigator.vibrate(120);
  });
});

  let isPlaying = false;
  let utterance = null;

  function updateGempa(teks,magn){
    scrollEl.style.opacity = 0;
    setTimeout(()=>{scrollEl.textContent = teks; scrollEl.className='scrolling-text'; if(magn<4) scrollEl.style.color='lightgreen'; else if(magn<5) scrollEl.style.color='#f5f5b0'; else if(magn<6) scrollEl.style.color='orange'; else scrollEl.style.color='darkred'; scrollEl.style.opacity=1},250);
  }

  async function fetchGempa(){
    try{
      const r = await fetch('https://data.bmkg.go.id/DataMKG/TEWS/autogempa.json');
      const d = await r.json();
      const g = d.Infogempa.gempa;
      const magn=parseFloat(g.Magnitude);
      const teks = `ðŸŒ‹ GEMPA ${g.Tanggal} pukul ${g.Jam} | Magnitudo: ${g.Magnitude} SR | Kedalaman: ${g.Kedalaman} | Lokasi: ${g.Wilayah} | Koordinat: ${g.Lintang}, ${g.Bujur} | Dirasakan: ${g.Dirasakan || '-'} | Potensi: ${g.Potensi || '-'}`;
      updateGempa(teks,magn);
    }catch(e){console.warn('fetch gempa',e); updateGempa('âš ï¸ Gagal memuat data gempa dari BMKG.',0)}
  }
  fetchGempa(); setInterval(fetchGempa,5*60*1000);

  function ripple(el,x,y){
    el.classList.remove('ripple');
    void el.offsetWidth; // reflow
    el.style.setProperty('--rx',x+'px');
    el.style.setProperty('--ry',y+'px');
    el.classList.add('ripple');
  }

  async function startTTS(){
    const text = document.getElementById('scrollGempa').innerText || 'Tidak ada teks.';
    if(!('speechSynthesis' in window)){
      // fallback to host
      return alert('SpeechSynthesis tidak tersedia. Buka di Chrome.');
    }
    window.speechSynthesis.cancel();
    utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'id-ID'; utterance.rate=1; utterance.pitch=1;
    utterance.onend = ()=>{stopTTS()};
    window.speechSynthesis.speak(utterance);
    isPlaying = true; showEqualizer(); animateEqualizer(); ttsBtn.classList.remove('btn-play'); ttsBtn.classList.add('btn-stop'); ttsBtn.textContent='â¹ Stop Baca';
  }
  function stopTTS(){
    window.speechSynthesis.cancel(); isPlaying=false; equalizer.classList.add('hidden'); ttsBtn.classList.remove('btn-stop'); ttsBtn.classList.add('btn-play'); ttsBtn.textContent='ðŸ”Š Baca Info Gempa';
  }

  function showEqualizer(){ equalizer.classList.remove('hidden'); }
  function animateEqualizer(){ if(!isPlaying) return; bars.forEach(b=>{ const h = 8 + Math.random()*60; b.style.height = h+'px'; }); requestAnimationFrame(animateEqualizer); }

  // ensure beep plays only on user gesture; attach to button click
  function playBeep(){ try{ beep.currentTime = 0; const p = beep.play(); if(p && p.catch) p.catch(()=>console.warn('beep blocked')); }catch(e){console.warn('beep play err',e);} }

  ttsBtn.addEventListener('click', (ev)=>{
    // ripple
    const rect = ttsBtn.getBoundingClientRect(); const x = ev.clientX - rect.left; const y = ev.clientY - rect.top; ripple(ttsBtn,x,y);
    // play beep then start TTS (small delay to let beep start)
    playBeep(); setTimeout(()=>{ if(!isPlaying) startTTS(); else stopTTS(); },140);
  });
  
  // ping indicator
  const pingBox = document.getElementById('pingBox');
  async function pingTest(){ const start = performance.now(); try{ await fetch('https://www.google.com', {mode:'no-cors'}); const d = Math.round(performance.now()-start); pingBox.innerText = `ðŸ“¶ ${d} ms`; pingBox.style.background = d<80? 'rgba(76,175,80,.55)': d<150? 'rgba(255,193,7,.55)': 'rgba(244,67,54,.55)'; }catch(e){ pingBox.innerText='âŒ Offline'; pingBox.style.background='rgba(244,67,54,.55)'; }}
  setInterval(pingTest,2500); pingTest();

  // auto fullscreen when opened as PWA or after first interaction
  async function goFullscreen(){ try{ if(document.fullscreenElement) return; await document.documentElement.requestFullscreen(); try{ await screen.orientation.lock('portrait'); }catch(e){} }catch(e){} }
  // request fullscreen on install/first click
  window.addEventListener('appinstalled', ()=>goFullscreen());
  // also try once on load if in standalone
  if(window.matchMedia('(display-mode: standalone)').matches) goFullscreen();

  // small UX: prevent accidental double clicks
  let lastClick=0; document.addEventListener('click', ()=>{ const now=Date.now(); if(now-lastClick<120) event.preventDefault(); lastClick=now; }, true);

});

// NOTE: web pages cannot disable OS navigation buttons programmatically for security/privacy reasons.
// When installed as a PWA and running fullscreen many browsers hide the browser chrome but cannot fully
// disable hardware navigation keys. That requires native app privileges.
</script>
</body>
</html>
