<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta Gempa BMKG Interaktif + TTS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family:'Poppins',sans-serif; background:linear-gradient(180deg,#eef5ff,#ffffff); text-align:center; margin:0; padding:0; }
  h2 { color:purple; margin-top:10px; font-size:16px; }
  #map { height:400px; width:95%; margin:10px auto; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
  .scroll-container { width:95%; overflow:hidden; white-space:nowrap; margin:10px auto; border-radius:3px; padding:5px; font-size:10px; font-weight:bold; }
  .scroll-text { display:inline-block; padding-left:100%; animation:scroll-left 60s linear infinite; }
  @keyframes scroll-left { 0%{transform:translateX(100%);} 100%{transform:translateX(-100%);} }
  .warna-abu-emas{background:linear-gradient(90deg,#fffbe0,#f7f1c0);color:#555;}
  .warna-orange{background:linear-gradient(90deg,#ffe0b2,#ffb74d);color:#5a2c00;}
  .warna-merah-maron{background:linear-gradient(90deg,#ffb3b3,#ff4444);color:#fff;}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,50,50,0.5);}70%{box-shadow:0 0 0 15px rgba(255,50,50,0);}100%{box-shadow:0 0 0 0 rgba(255,50,50,0);}}
  .pulse{animation:pulse 2s infinite;}
  @keyframes shake{0%,100%{transform:translate(0,0);}20%{transform:translate(-3px,2px);}40%{transform:translate(3px,-2px);}60%{transform:translate(-2px,2px);}80%{transform:translate(2px,-1px);}}
  .shake{animation:shake 0.5s ease-in-out infinite;}
  #muteBtn,#ttsBtn{background:#333;color:white;border:none;border-radius:20px;padding:8px 16px;margin:5px;cursor:pointer;transition:background 0.3s;}
  #muteBtn:hover,#ttsBtn:hover{background:#555;}
  #popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%)scale(0.8);background:radial-gradient(circle at top left,#ff4d4d,#b30000);color:#fff;padding:25px 30px;border-radius:15px;box-shadow:0 4px 30px rgba(0,0,0,0.3);opacity:0;transition:all 0.5s ease;z-index:9999;}
  #popup.show{opacity:1;transform:translate(-50%,-50%)scale(1);}
  #popup button{margin-top:10px;background:#fff;color:#b30000;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;}
</style>
</head>
<body>

<h2>üåã Info Gempa BMKG Terkini</h2>
<div id="scrollGempa" class="scroll-container warna-abu-emas">
  <div class="scroll-text">Memuat data gempa...</div>
</div>

<button id="ttsBtn">üéß Dengarkan Info Gempa</button>
<button id="muteBtn">üîä MUTE</button>
<div id="map"></div>

<audio id="gemuruhAudio" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_36db5618f8.mp3?filename=deep-rumble-6265.mp3"></audio>

<div id="popup">
  <h3>‚ö†Ô∏è Peringatan Gempa Besar!</h3>
  <p id="popupText"></p>
  <button onclick="closePopup()">Tutup</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([-2.5,118],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:10}).addTo(map);
let marker=null;

const scrollContainer=document.getElementById('scrollGempa');
const scrollText=scrollContainer.querySelector('.scroll-text');
const audio=document.getElementById('gemuruhAudio');
const popup=document.getElementById('popup');
const popupText=document.getElementById('popupText');
let isMuted=false;

// üîä Tombol MUTE
document.getElementById('muteBtn').addEventListener('click',()=>{
  isMuted=!isMuted;
  document.getElementById('muteBtn').textContent=isMuted?'üîá UNMUTE':'üîä MUTE';
  if(isMuted) audio.pause();
});

// üîà Fungsi TTS
function speak(text){
  if(!window.speechSynthesis){ alert("Browser Anda tidak mendukung TTS."); return; }
  const utter=new SpeechSynthesisUtterance(text);
  let voices=speechSynthesis.getVoices();
  let indo=voices.find(v=>v.lang.startsWith('id')) || voices.find(v=>v.lang.startsWith('en'));
  utter.voice=indo;
  utter.pitch=1.1;
  utter.rate=1;
  utter.volume=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

function showPopup(teks){
  popupText.innerHTML=teks;
  popup.classList.add('show');
}
function closePopup(){ popup.classList.remove('show'); }

function updateGempa(teks,magnitudo,lat,lon,lokasi,waktu){
  scrollContainer.style.opacity=0;
  setTimeout(()=>{
    scrollText.textContent=teks;
    scrollContainer.className='scroll-container';
    if(magnitudo<5) scrollContainer.classList.add('warna-abu-emas');
    else if(magnitudo<6) scrollContainer.classList.add('warna-orange','pulse');
    else scrollContainer.classList.add('warna-merah-maron','pulse');
    scrollContainer.style.opacity=1;
    scrollText.classList.add('scroll-text');

    if(magnitudo>=5 && !isMuted){ audio.currentTime=0; audio.play(); }

    if(magnitudo>=6){ showPopup(`Terjadi gempa besar <b>${magnitudo} SR</b><br>Lokasi: ${lokasi}<br>Waktu: ${waktu}`); }

    if(marker) map.removeLayer(marker);
    marker=L.marker([lat,lon]).addTo(map)
      .bindPopup(`<b>${lokasi}</b><br>${magnitudo} SR<br>${waktu}`).openPopup();
    map.setView([lat,lon],6);
  },700);
}

// üéß Tombol TTS ditekan
document.getElementById('ttsBtn').addEventListener('click',()=>{
  fetchGempa(true);
});

async function fetchGempa(playTTS=false){
  try{
    const res=await fetch('https://data.bmkg.go.id/DataMKG/TEWS/autogempa.json');
    const data=await res.json();
    const g=data.Infogempa.gempa;
    const magnitudo=parseFloat(g.Magnitude);
    const lokasi=g.Wilayah;
    const waktu=`${g.Tanggal} ${g.Jam}`;
    const lat=parseFloat(g.Lintang);
    const lon=parseFloat(g.Bujur);
    const teks=`üåã ${waktu} | Magnitudo: ${magnitudo} SR | Kedalaman: ${g.Kedalaman} | Lokasi: ${lokasi} | Potensi: ${g.Potensi}`;
    updateGempa(teks,magnitudo,lat,lon,lokasi,waktu);
    if(playTTS){
      const ttsText=`Terjadi gempa bumi berkekuatan ${magnitudo} skala Richter di wilayah ${lokasi}. 
      Terjadi pada ${waktu}. Kedalaman ${g.Kedalaman}. ${g.Potensi}.`;
      speak(ttsText);
    }
  }catch(e){
    console.error('Gagal ambil data BMKG:',e);
    updateGempa('‚ö†Ô∏è Gagal memuat data BMKG.',0,-2.5,118,'','');
  }
}

fetchGempa();
setInterval(fetchGempa,5*60*1000);
</script>
</body>
</html>
