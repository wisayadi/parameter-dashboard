<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Info Gempa BMKG</title>

<style>

/* ====== AREA GEMPA BERJALAN ====== */
.info-gempa {
  width: 100%;
  overflow: hidden;
  white-space: nowrap;
  background: #0a0a0a;
  padding: 8px 0;
  border-bottom: 2px solid #ffcc00;
}
.scrolling-text {
  display: inline-block;
  padding-left: 100%;
  animation: scroll-left 25s linear infinite;
  font-size: 15px;
  font-family: Arial, sans-serif;
}
@keyframes scroll-left {
  0% { transform: translateX(0%); }
  100% { transform: translateX(-100%); }
}

.warna-abu-emas { color: #ffeb3b; font-weight:bold; }

/* ====== TOMBOL TTS ====== */
#ttsToggle {
  background: linear-gradient(90deg,#4facfe,#00f2fe);
  color: white;
  border: none;
  padding: 10px 18px;
  margin: 12px auto;
  border-radius: 22px;
  display: block;
  font-size: 15px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
#ttsToggle.stopping { background:#e53935; }

/* ===== Test voice button */
#testVoicesBtn {
  margin: auto;
  display: block;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 14px;
}

</style>
</head>
<body>

<!-- ðŸ”¹ INFO GEMPA BERJALAN -->
<div class="info-gempa">
  <span id="scrollGempa" class="scrolling-text warna-abu-emas">
    Memuat data gempa terkini dari BMKG...
  </span>
</div>

<!-- TOMBOL TTS -->
<button id="ttsToggle" aria-pressed="false">ðŸ”Š Baca Info Gempa</button>
<button id="testVoicesBtn">ðŸ§ª Test Voice</button>

<script>
    /*const scrollElem = document.getElementById('scrollGempa');*/

  // ðŸ” Efek ganti teks halus
  function updateGempa(teks, magnitudo) {
    scrollElem.style.opacity = 0;
    setTimeout(() => {
      scrollElem.textContent = teks;
      scrollElem.className = 'scrolling-text';
          
      if (magnitudo < 4.0) scrollElem.classList.add('warna-hijau');
      else if (magnitudo < 5.0) scrollElem.classList.add('warna-abu-emas');
      else if (magnitudo >= 5.0 && magnitudo < 6.0) scrollElem.classList.add('warna-orange');
      else scrollElem.classList.add('warna-merah-maron');       
      scrollElem.style.opacity = 1;
    }, 800);
  }

  // ðŸŒ Ambil data gempa dari API BMKG
  async function fetchGempa() {
    try {
      const res = await fetch('https://data.bmkg.go.id/DataMKG/TEWS/autogempa.json');
      const data = await res.json();

      const g = data.Infogempa.gempa;
      const magnitudo = parseFloat(g.Magnitude);
      const lokasi = g.Wilayah;
      const waktu = g.Tanggal + ' ' + g.Jam;
      const dirasakan = g.Dirasakan;
      const teks = `ðŸŒ‹ GEMPA ${g.Tanggal} pukul ${g.Jam} | Magnitudo: ${g.Magnitude} SR | Kedalaman: ${g.Kedalaman} | Lokasi: ${g.Wilayah} | Koordinat: ${g.Lintang}, ${g.Bujur} | Dirasakan: ${dirasakan} | Potensi: ${g.Potensi}`;
      
      updateGempa(teks, magnitudo);
    } catch (e) {
      console.error('Gagal ambil data BMKG:', e);
      updateGempa('âš ï¸ Gagal memuat data gempa dari BMKG.', 0);
    }
  }

  // â± Jalankan pertama kali & perbarui tiap 5 menit
  fetchGempa();
  setInterval(fetchGempa, 5 * 60 * 1000);
  

/* ========= TTS INTEGRASI ========= */
const ttsBtn = document.getElementById('ttsToggle');
const scrollElem = document.getElementById('scrollGempa');
let isSpeaking = false;
let lastSpokenText = "";

/* ðŸ” Deteksi App WebView */
function isInAppWebView() {
  return typeof window.AppInventor !== 'undefined' ||
         typeof window.setWebViewString === 'function';
}

/* Fallback: kirim ke app native */
function sendToHostTTS(text) {
  try {
    if (window.AppInventor && window.AppInventor.setWebViewString)
      window.AppInventor.setWebViewString("TTS:" + text);
    
    else if (window.setWebViewString)
      window.setWebViewString("TTS:" + text);
  } catch(e) { console.log("Host TTS Err", e); }
}

/* Browser speech synthesis */
function speakInBrowser(text) {
  try { window.speechSynthesis.cancel(); } catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "id-ID";
  u.rate = 1;
  u.pitch = 1;

  u.onend = () => { isSpeaking = false; updateBtn(); };

  isSpeaking = true;
  updateBtn();
  window.speechSynthesis.speak(u);
}

function stopAllTTS() {
  try { window.speechSynthesis.cancel(); } catch(e){}
  try { sendToHostTTS("STOP"); } catch(e){}
  isSpeaking = false;
  updateBtn();
}

function updateBtn() {
  if (isSpeaking) {
    ttsBtn.textContent = "â¹ Stop";
    ttsBtn.classList.add("stopping");
  } else {
    ttsBtn.textContent = "ðŸ”Š Baca Info Gempa";
    ttsBtn.classList.remove("stopping");
  }
}

function toggleTTS() {
  const text = scrollElem.innerText.trim();
  if (!text) { alert("Belum ada teks informasi gempa."); return; }

  if (isSpeaking) {
    stopAllTTS();
    return;
  }

  if (!!window.speechSynthesis && !isInAppWebView()) {
    speakInBrowser(text);
    lastSpokenText = text;
    return;
  }

  sendToHostTTS(text);
  isSpeaking = true;
  updateBtn();
}

ttsBtn.addEventListener("click", toggleTTS);

/* === TES VOICE === */
document.getElementById("testVoicesBtn").addEventListener("click", () => {
  const v = speechSynthesis.getVoices();
  alert(v.map(e => e.name+" ("+e.lang+")").join("\n"));
  const test = new SpeechSynthesisUtterance("Tes suara");
  test.lang = "id-ID";
  speechSynthesis.speak(test);
});
</script>

</body>
</html>
